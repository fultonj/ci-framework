---
# 9 OCP nodes = 3 schedulable masters + 6 workers
pre_deploy:
  - name: 01 make masters schedulable
    type: cr
    definition:
      spec:
        mastersSchedulable: true
    kind: Scheduler
    resource_name: cluster
    state: patched

# devscripts settings
cifmw_use_devscripts: true
cifmw_devscripts_remove_libvirt_net_default: true
cifmw_devscripts_enable_ocp_nodes_host_routing: true
cifmw_devscripts_cinder_volume_pvs: []

# libvirt settings
cifmw_use_libvirt: true
cifmw_libvirt_manager_pub_net: ocpbm

cifmw_use_uefi: >-
  {{ (cifmw_repo_setup_os_release is defined
      and cifmw_repo_setup_os_release == 'rhel') | bool }}
cifmw_root_partition_id: >-
  {{
    (cifmw_repo_setup_os_release is defined and cifmw_repo_setup_os_release == 'rhel') |
    ternary(4, 1)
  }}

# layout
cifmw_libvirt_manager_configuration:
  networks:
    osp_trunk: |
      <network>
        <name>osp_trunk</name>
        <forward mode='nat'/>
        <bridge name='osp_trunk' stp='on' delay='0'/>
        <dns enable="no"/>
        <ip family='ipv4'
        address='{{ cifmw_networking_definition.networks.ctlplane.network |
                    ansible.utils.nthhost(1) }}'
        prefix='{{ cifmw_networking_definition.networks.ctlplane.network |
                   ansible.utils.ipaddr('prefix') }}'>
        </ip>
      </network>
    ocpbm: |
      <network>
        <name>ocpbm</name>
        <forward mode='nat'/>
        <bridge name='ocpbm' stp='on' delay='0'/>
        <dns enable="no"/>
        <ip family='ipv4' address='192.168.111.1' prefix='24'>
        </ip>
      </network>
    ocppr: |
      <network>
        <name>ocppr</name>
        <forward mode='bridge'/>
        <bridge name='ocppr'/>
      </network>

  vms:
    ocp:
      amount: 3
      admin_user: core
      image_local_dir: "{{ cifmw_basedir }}/images/"
      disk_file_name: "ocp_master"
      disksize: "100"
      extra_disks_num: 3
      extra_disks_size: "50G"
      cpus: 10
      memory: 32
      uefi: true
      root_part_id: 4
      nets:
        - ocppr
        - ocpbm
        - osp_trunk

    ocp_worker:
      amount: 6
      admin_user: core
      image_local_dir: "{{ cifmw_basedir }}/images/"
      disk_file_name: "ocp_worker"
      disksize: "100"
      extra_disks_num: 3
      extra_disks_size: "50G"
      cpus: 10
      memory: 16
      root_part_id: 4
      uefi: true
      nets:
        - ocppr
        - ocpbm
        - osp_trunk

    compute:
      amount: 1
      uefi: "{{ cifmw_use_uefi }}"
      root_part_id: "{{ cifmw_root_partition_id }}"
      image_url: "{{ cifmw_discovered_image_url }}"
      sha256_image_name: "{{ cifmw_discovered_hash }}"
      image_local_dir: "{{ cifmw_basedir }}/images/"
      disk_file_name: "base-os.qcow2"
      disksize: 50
      memory: 16
      cpus: 8
      nets:
        - ocpbm
        - osp_trunk

    controller:
      root_part_id: "{{ cifmw_root_partition_id }}"
      image_url: "{{ cifmw_discovered_image_url }}"
      sha256_image_name: "{{ cifmw_discovered_hash }}"
      image_local_dir: "{{ cifmw_basedir }}/images/"
      disk_file_name: "base-os.qcow2"
      disksize: 50
      extra_disks_num: 3
      extra_disks_size: "50G"
      memory: 8
      cpus: 4
      nets:
        - ocpbm
        - osp_trunk
